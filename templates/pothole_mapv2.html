<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Pothole Map - GPS Logs</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <style>
            body {
                background: #111;
                color: #fff;
                font-family: Arial, sans-serif;
                padding: 20px;
                margin: 0;
            }
            h1 {
                color: #00ff88;
                text-shadow: 0 0 10px #00ff88;
                text-align: center;
            }
            .container {
                max-width: 1400px;
                margin: 0 auto;
            }
            .stats {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .stat-card {
                background: #222;
                padding: 20px;
                border-radius: 12px;
                border: 2px solid #00ff88;
                flex: 1;
                min-width: 200px;
            }
            .stat-value {
                font-size: 36px;
                color: #00ff88;
                font-weight: bold;
            }
            .stat-label {
                color: #9f9;
                margin-top: 5px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                background: #222;
                border-radius: 12px;
                overflow: hidden;
            }
            th {
                background: #00ff88;
                color: #000;
                padding: 15px;
                text-align: left;
                font-weight: bold;
            }
            td {
                padding: 12px 15px;
                border-bottom: 1px solid #333;
                vertical-align: middle;
            }
            tr:hover {
                background: #2a2a2a;
            }
            .confidence {
                color: #00ff88;
                font-weight: bold;
            }
            .coords {
                font-family: monospace;
                color: #9f9;
            }
            .bbox {
                font-family: monospace;
                font-size: 11px;
                color: #888;
                max-width: 200px;
            }
            .bbox-item {
                padding: 8px 12px;
                margin: 4px 0;
                background: #333;
                border-radius: 4px;
                cursor: pointer;
                transition: 0.2s;
                border-left: 3px solid #00ff88;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .bbox-item:hover {
                background: #444;
                border-left-color: #00ff00;
                transform: translateX(3px);
            }
            .bbox-item.validated-yes {
                border-left-color: #00cc00;
                background: #1a3a1a;
            }
            .bbox-item.validated-no {
                border-left-color: #cc0000;
                background: #3a1a1a;
            }
            .bbox-status {
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 3px;
                font-weight: bold;
            }
            .bbox-status.yes {
                background: #00cc00;
                color: #fff;
            }
            .bbox-status.no {
                background: #cc0000;
                color: #fff;
            }
            button {
                padding: 12px 24px;
                background: #00ff88;
                color: #000;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                margin: 10px 5px;
            }
            button:hover {
                background : #00cc70;
            }
            .export-btn {
                background: #ff8800;
            }
            .export-btn:hover {
                background: #cc6600;
            }
            .thumbnail {
                width: 120px;
                height: 90px;
                object-fit: cover;
                border-radius: 6px;
                cursor: pointer;
                border: 2px solid #333;
                transition: 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
            .thumbnail:hover {
                border-color: #00ff88;
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(0,255,136,0.3);
            }
            .no-image {
                width: 120px;
                height: 90px;
                background: #333;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                color: #666;
                border: 2px dashed #444;
            }
            .val-btn {
                padding: 8px 14px;
                font-size: 13px;
                border-radius: 6px;
                border: none;
                cursor: pointer;
                font-weight: bold;
                transition: 0.2s;
            }
            .val-yes {
                background: #00cc00;
                color: #fff;
            }
            .val-yes:hover {
                background: #00ff00;
            }
            .val-no {
                background: #cc0000;
                color: #fff;
            }
            .val-no:hover {
                background: #ff0000;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                animation: fadeIn 0.2s;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .modal-content-wrapper{
                position: relative;
                margin: 50px auto;
                max-width: 90%;
                max-height: 80%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .modal-canvas {
                max-width: 100%;
                max-height: 80vh;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,255,136,0.3);
            }
            .close {
                position: absolute;
                top: 30px;
                right: 50px;
                color: #fff;
                font-size: 40px;
                font-weight: bold;
                cursor: pointer;
                transition: 0.2s;
                z-index: 1001;
            }
            .close:hover {
                color: #00ff88;
                transform: scale(1.1);
            }
            .modal-info {
                position: absolute;
                top: 100px;
                left: 50px;
                background: rgba(0,0,0,0.8);
                padding: 15px;
                border-radius: 8px;
                border: 2px solid #00ff88;
                max-width: 300px;
                z-index: 1001;
            }
            .modal-info h3 {
                color: #00ff88;
                margin-top: 0;
            }
            .modal-info p {
                margin: 5px 0;
                font-size: 14px;
            }
            .modal-validation {
                position: absolute;
                bottom: 50px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.9);
                padding: 20px 30px;
                border-radius: 8px;
                border: 2px solid #00ff88;
                z-index: 1001;
                display: flex;
                gap: 15px;
                align-items: center;
            }
            .modal-validation .val-btn {
                padding: 12px 24px;
                font-size: 15px;
            }
            .filter-controls {
                background: #222;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                gap: 15px;
                align-items: center;
                flex-wrap: wrap;
            }
            .filter-controls label {
                color: #00ff88;
                font-weight: bold;
            }
            .filter-controls select {
                padding: 8px;
                border-radius: 4px;
                background: #333;
                color: #fff;
                border: 1px solid #00ff88;
            }
        </style>
    </head>
    <body>
        <div class ="container">
            <h1>Pothole Detection Map & Validation</h1>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Detections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBoxes">0</div>
                    <div class="stat-label">Total Boxes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="validatedCount">0</div>
                    <div class="stat-label">Validated Boxes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="confirmedCount">0</div>
                    <div class="stat-label">Confirmed Potholes</div>
                </div>                
            </div>

            <div class="filter-controls">
                <label for="filterValidation">Filter by:</label>
                <select id="filterValidation" onchange="applyFilters()">
                    <option value="all">All Detections</option>
                    <option value="pending">Pending Validation</option>
                    <option value="valid">Confirmed Potholes</option>
                    <option value="invalid">Not Potholes</option>
                </select>

                <label for="filterImage" style="margin-left: 20px;">Show:</label>
                <select id="filterImage" onchange="applyFilters()">
                    <option value="all">All</option>
                    <option value="with-image">With Screenshots Only</option>
                    <option value="no-image">No Screenshots Only</option>
                </select>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button onClick="loadPotholes()">Refresh Data</button>
                <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
                <button class="export-btn" onclick="exportToGeoJSON()">Export JSON</button>
            </div>

            <table id="potholeTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Screenshot</th>
                        <th>Timestamp</th>
                        <th>GPS Location</th>
                        <th>Confidence</th>
                        <th>Bounding Boxes (Click to View)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="imageModal" class="modal" onclick="closeModal(event)">
            <span class="close">&times;</span>
            <div class="modal-info" id="modalInfo"></div>
            <div class="modal-content-wrapper">
                <canvas id="modalCanvas" class="modal-canvas"></canvas>
            </div>
            <div class="modal-validation" id="modalValidation"></div>
        </div>

        <script>
            let potholes = [];
            let filteredPotholes = [];

            async function loadPotholes() {
                try {
                    const response = await fetch('/get_potholes');
                    const data = await response.json();

                    if (data.status ==='success') {
                        potholes = data.detections;
                        applyFilters();
                        updateStats();
                    }
                } catch (err) {
                    console.error('Error loading potholes:', err);
                    document.getElementById('tableBody').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; color: red;">Error loading data</td></tr>';                  
                }
            }

            function applyFilters() {
                const validationFilter = document.getElementById('filterValidation').value;
                const imageFilter = document.getElementById('filterImage').value;

                filteredPotholes = potholes.filter(p => {
                    let passValidation = true;
                    if(validationFilter !== 'all' && p.bounding_boxes) {
                        const hasMatchingBox = p.bounding_boxes.some(box => {
                            if(validationFilter === 'pending') {
                                return box.validated === null || box.validated === undefined;
                            } else if (validationFilter === 'valid') {
                                return box.validated === true;
                            } else if (validationFilter === 'invalid') {
                                return box.validated === false;
                            }
                            return true;
                        });
                        passValidation = hasMatchingBox;
                    }

                    let passImage = true;
                    if (imageFilter === 'with-image') {
                        passImage = p.screenshot !== null && p.screenshot !== undefined;
                    } else if (imageFilter === 'no-image') {
                        passImage = !p.screenshot;
                    }

                    return passValidation && passImage;
                });

                displayPotholes();
            }

            function displayPotholes() {
                const tbody = document.getElementById('tableBody');

                if (filteredPotholes.length ===0){
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No potholes match the filters</td></tr>';
                    return;
                }

                tbody.innerHTML = filteredPotholes.map((p, index) => {
                    const imgHtml = p.screenshot
                    ? `<img src="/screenshots/${p.screenshot}" class="thumbnail" onclick="openModal('${p.id}', -1)" alt="All Boxes" title="Click to see all boxes">`
                    : `<div class="no-image">No Image</div>`;

                    const bboxHtml = p.bounding_boxes && p.bounding_boxes.length > 0
                    ? `<div style="max-height: 200px; overflow-y: auto;">
                        ${p.bounding_boxes.map((box, i) => {
                            const validated = box.validated;
                            const statusClass = validated === true ? 'validated-yes' : validated === false ? 'validated-no' : '';
                            const statusBadge = validated === true ? '<span class="bbox-status yes">✓</span>' :
                                              validated === false ? '<span class="bbox-status no">✗</span>' : '';
                                              
                            return `<div class="bbox-item ${statusClass}" onclick="openModal('${p.id}', ${i})" title="Click to view this box">
                                <span><strong>Box ${i+1}:</strong> [${box.coords.join(', ')}]</span>
                                ${statusBadge}
                            </div>`;                
                        }).join('')}
                    </div>`
                    : '<span style="color: #666;">N/A</span>';

                    const actualIndex = potholes.indexOf(p) + 1;

                    return `
                        <tr>
                            <td><strong>#${actualIndex}</strong></td>
                            <td style="text-align: center;">${imgHtml}</td>
                            <td>
                                ${new Date(p.timestamp).toLocaleString()}<br>
                                <small style="color: #888;">${timeSince(new Date(p.timestamp))}</small>
                            </td>
                            <td class="coords">
                                <strong>Latitude:</strong> ${p.latitude.toFixed(6)}<br>
                                <strong>Longitude:</strong> ${p.longitude.toFixed(6)}<br>
                                <small style="color: #888;">Accuracy: ±${p.accuracy ? p.accuracy.toFixed(1) + 'm' : 'N/A'}</small>
                            </td>
                            <td class="confidence">
                                ${(p.confidence * 100).toFixed(1)}%<br>
                                <small style="color: #888;">${p.bounding_boxes ? p.bounding_boxes.length : 0} box${(p.bounding_boxes && p.bounding_boxes.length > 1) ? 'es' : ''}</small>
                            </td>
                            <td class="bbox">${bboxHtml}</td>
                            <td>
                                <a href="https://www.google.com/maps?q=${p.latitude},${p.longitude}"
                                target="_blank" style="color: #00ff88; text-decoration: none; font-weight: bold;">
                                View on Map
                                </a>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function timeSince(date){
                const seconds = Math.floor((new Date() - date)/ 1000);

                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
                if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
                return Math.floor(seconds / 86400) + ' days ago';
            }

            function updateStats() {
                document.getElementById('totalCount').textContent = potholes.length;

                let totalBoxes = 0;
                let validatedBoxes = 0;
                let confirmedBoxes =0;

                potholes.forEach(p => {
                    if (p.bounding_boxes) {
                        totalBoxes += p.bounding_boxes.length;
                        p.bounding_boxes.forEach(box => {
                            if (box.validated !== null && box.validated !== undefined) {
                                validatedBoxes++;
                                if(box.validated === true) {
                                    confirmedBoxes++;
                                }
                            }
                        });
                    }
                });

                document.getElementById('totalBoxes').textContent = totalBoxes;
                document.getElementById('validatedCount').textContent = validatedBoxes;
                document.getElementById('confirmedCount').textContent = confirmedBoxes;
            }

            function openModal(id, boxIndex) {
                const pothole = potholes.find(p => p.id === id);
                if (!pothole || !pothole.screenshot) return;

                const modal = document.getElementById('imageModal');
                const canvas = document.getElementById('modalCanvas');
                const ctx = canvas.getContext('2d');
                const modalInfo = document.getElementById('modalInfo');
                const modalValidation = document.getElementById('modalValidation');

                modal.style.display = 'block';

                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    if (boxIndex >= 0 && pothole.bounding_boxes && pothole.bounding_boxes[boxIndex]) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        const selectedBox = pothole.bounding_boxes[boxIndex].coords;
                        const [x1, y1, x2, y2] = selectedBox;
                        const padding = 20;

                        ctx.clearRect(
                            Math.max(0, x1 - padding),
                            Math.max(0, y1 - padding),
                            (x2 - x1) + (padding * 2),
                            (y2 - y1) + (padding * 2)
                        );

                        ctx.drawImage(
                            img,
                            Math.max(0, x1 - padding),
                            Math.max(0, y1 - padding),
                            (x2 - x1) + (padding * 2),
                            (y2 - y1) + (padding * 2),
                            Math.max(0, x1 - padding),
                            Math.max(0, y1 - padding),
                            (x2 - x1) + (padding * 2),
                            (y2 - y1) + (padding * 2)
                        );

                        drawBox(ctx, selectedBox, `Box ${boxIndex + 1}`, '#00ff00');
                    } else {
                        if (pothole.bounding_boxes) {
                            pothole.bounding_boxes.forEach((box, i) => {
                                drawBox(ctx, box.coords, `Box ${i+1}`, '#00ff88');
                            });
                        }
                    }
                };
                img.src = `/screenshots/${pothole.screenshot}`;

                const boxInfo = boxIndex === -1
                    ? `All ${pothole.bounding_boxes ? pothole.bounding_boxes.length : 0} boxes`
                    : `Box ${boxIndex + 1} of ${pothole.bounding_boxes ? pothole.bounding_boxes.length : 0}`;

                modalInfo.innerHTML = `
                    <h3>Detection Details </h3>
                    <p><strong>Time:</strong> ${new Date(pothole.timestamp).toLocaleString()}</p>
                    <p><strong>Confidence:</strong> ${(pothole.confidence * 100).toFixed(1)}%</p>
                    <p><strong>Latitude:</strong> ${pothole.latitude.toFixed(6)}</p>
                    <p><strong>Longitude:</strong> ${pothole.longitude.toFixed(6)}</p>
                    <p><strong>Viewing: </strong> ${boxInfo}</p>
                `;

                if(boxIndex >= 0 && pothole.bounding_boxes && pothole.bounding_boxes[boxIndex]) {
                    const box = pothole.bounding_boxes[boxIndex];

                    if (box.validated === null || box.validated === undefined) {
                        modalValidation.innerHTML = `
                            <span style="color: #00ff88; font-weight: bold; margin-right: 10px;">Is this a pothole?</span>
                            <button class="val-btn val-yes" 
                                    onclick="validateBox('${id}', ${boxIndex}, true)">
                                ✓ Yes, Pothole
                            </button>
                            <button class="val-btn val-no" 
                                    onclick="validateBox('${id}', ${boxIndex}, false)">
                                ✗ Not a Pothole
                            </button>
                        `;
                        modalValidation.style.display = 'flex';
                    } else {
                        const status = box.validated ? 'Confirmed Pothole' : 'Not a Pothole';
                        const statusColor = box.validated ? '#00cc00' : '#cc0000';
                        modalValidation.innerHTML = `
                            <span style="color: ${statusColor}; font-weight: bold; font-size: 16px;">
                                ${status}
                            </span>
                        `;
                        modalValidation.style.display = 'flex';
                    }
                } else {
                    modalValidation.style.display = 'none';
                }
            }

            function drawBox(ctx, box, label, color) {
                const [x1, y1, x2, y2] = box;

                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                ctx.fillStyle = color;
                const labelText = label;
                ctx.font = 'bold 16px Arial';
                const textWidth = ctx.measureText(labelText).width;
                ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);

                ctx.fillStyle = '#000';
                ctx.fillText(labelText, x1 + 5, y1 - 7);
            }

            async function validateBox(id, boxIndex, isValid) {
                try {
                    const response = await fetch('/validate_pothole', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: id,
                            box_index: boxIndex,
                            is_valid: isValid
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        console.log(`Box ${boxIndex} of detection ${id} validated as ${isValid ? 'valid' : 'invalid'}`);
                        closeModal();
                        await loadPotholes();
                    }
                } catch (err) {
                    console.error('Error validating pothole:', err);
                    alert('Failed to save validation. Please try again.');
                }
            }

            function closeModal(event) {
                if (event) {
                    const canvas = document.getElementById('modalCanvas');
                    const modalInfo = document.getElementById('modalInfo');
                    const modalValidation = document.getElementById('modalValidation');
                    if (event.target === canvas || modalInfo.contains(event.target) || modalValidation.contains(event.target)) {
                        return;
                    }
                }
                document.getElementById('imageModal').style.display = 'none';
            }

            function exportToCSV() {
                const rows= [['Index', 'Timestamp', 'Latitude', 'Longitude', 'Confidence', 'BoxIndex', 'BoundingBox', 'Validated', 'Screenshot']];

                potholes.forEach((p, i) => {
                    if (p.bounding_boxes) {
                        p.bounding_boxes.forEach((box, boxIdx) => {
                            rows.push([
                                i + 1,
                                p.timestamp,
                                p.latitude,
                                p.longitude,
                                p.confidence,
                                boxIdx + 1,
                                `[${box.coords.join(',')}]`,
                                box.validated === null ? 'Pending' : (box.validated ? 'Valid' : 'Invalid'),
                                p.screenshot || 'N/A'
                            ]);
                        });
                    }
                });

                const csv = rows.map(row => row.join(',')).join('\n');
                downloadFile('potholes.csv', csv, 'text/csv');
            }

            function exportToGeoJSON() {
                const features = [];

                potholes.forEach((p, i) => {
                    if (p.bounding_boxes) {
                        p.bounding_boxes.forEach((box, boxIdx) => {
                             features.push({
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [p.longitude, p.latitude]
                                },
                                properties: {
                                    id: p.id,
                                    box_index: boxIdx,
                                    timestamp: p.timestamp,
                                    confidence: p.confidence,
                                    accuracy: p.accuracy,
                                    validated: box.validated,
                                    screenshot: p.screenshot,
                                    bounding_box: box.coords
                                }
                            });
                        });
                    }
                });

                const geojson = {
                    type: 'FeatureCollection',
                    features: features
                };

                downloadFile('potholes.geojson', JSON.stringify(geojson, null, 2), 'application/json')
            }

            function downloadFile(filename, content, mimeType) {
                const blob = new Blob ([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            document.addEventListener('keydown', (e) => {
                if(e.key === 'Escape') closeModal();
            });

            loadPotholes();
            
            setInterval(loadPotholes, 10000);
        </script>
    </body>
</html>