<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Pothole Map - GPS Logs</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <style>
            body {
                background: #111;
                color: #fff;
                font-family: Arial, sans-serif;
                padding: 20px;
                margin: 0;
            }
            h1 {
                color: #00ff88;
                text-shadow: 0 0 10px #00ff88;
                text-align: center;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .stats {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .stat-card {
                background: #222;
                padding: 20px;
                border-radius: 12px;
                border: 2px solid #00ff88;
                flex: 1;
                min-width: 200px;
            }
            .stat-value {
                font-size: 36px;
                color: #00ff88;
                font-weight: bold;
            }
            .stat-label {
                color: #9f9;
                margin-top: 5px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                background: #222;
                border-radius: 12px;
                overflow: hidden;
            }
            th {
                background: #00ff88;
                color: #000;
                padding: 15px;
                text-align: left;
                font-weight: bold;
            }
            td {
                padding: 12px 15px;
                border-bottom: 1px solid #333;
            }
            tr:hover {
                background: #2a2a2a;
            }
            .confidence {
                color: #00ff88;
                font-weight: bold;
            }
            .coords {
                font-family: monospace;
                color: #9f9;
            }
            button {
                padding: 12px 24px;
                background: #00ff88;
                color: #000;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                margin: 10px 5px;
            }
            button:hover {
                background : #00cc70;
            }
            .export-btn {
                background: #ff8800;
            }
            .export-btn:hover {
                background: #cc6600;
            }
        </style>
    </head>
    <body>
        <div class ="container">
            <h1>Pothole Detection Map</h1>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Detection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgConfidence">0%</div>
                    <div class="stat-label">Average Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgAccuracy">0</div>
                    <div class="stat-label">Average Accuracy</div>
                </div>                
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button onClick="loadPotholes()">Refresh Data</button>
                <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
                <button class="export-btn" onclick="exportToGeoJSON()">Export JSON</button>
            </div>

            <table id="potholeTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Timestamp</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Confidence</th>
                        <th>Count</th>
                        <th>Accuracy</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; color: #666;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script>
            let potholes = [];

            async function loadPotholes() {
                try {
                    const response = await fetch('/get_potholes');
                    const data = await response.json();

                    if (data.status ==='success') {
                        potholes = data.detections;
                        displayPotholes();
                        updateStats();
                    }
                } catch (err) {
                    console.error('Error loading potholes:', err);
                    document.getElementById('tableBody').innerHTML = 
                        '<tr><td colspan="8" style="text-align: center; color: red;">Error loading data</td></tr>';                  
                }
            }

            function displayPotholes() {
                const tbody = document.getElementById('tableBody');

                if (potholes.length ===0){
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">No potholes detected yet</td></tr>';
                    return;
                }

                tbody.innerHTML = potholes.map((p, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${new Date(p.timestamp).toLocaleString()}</td>
                        <td class="coords">${p.latitude.toFixed(6)}</td>
                        <td class="coords">${p.longitude.toFixed(6)}</td>
                        <td class="confidence">${(p.confidence * 100).toFixed(1)}%</td>
                        <td>${p.detection_count}</td>
                        <td>${p.accuracy ? p.accuracy.toFixed(1) + 'm' : 'N/A'}</td>
                        <td>
                            <a href="https://www.google.com/maps?q=${p.latitude},${p.longitude}" 
                            target="_blank" style="color: #00ff88;">View Map</a>
                        </td>
                    </tr>
                `).join('');
            }

            function updateStats() {
                document.getElementById('totalCount').textContent = potholes.length;

                if (potholes.length > 0) {
                    const avgConf = potholes.reduce((sum, p) => sum + p.confidence,0) / potholes.length;
                    document.getElementById('avgConfidence').textContent = (avgConf * 100).toFixed(1) +'%';

                    const validAccuracies = potholes.filter(p => p.accuracy).map(p => p.accuracy);
                    if (validAccuracies.length > 0) {
                        const avgAcc = validAccuracies.reduce((sum, a) => sum + a, 0) / validAccuracies.length;
                        document.getElementById('avgAccuracy').textContent = avgAcc.toFixed(1) + 'm';
                    }
                }
            }

            function exportToCSV() {
                const csv = [
                    ['Index', 'Timestamp', 'Latitude', 'Longitude', 'Confidence', 'Count', 'Accuracy'],
                    ...potholes.map((p, i) => [
                        i + 1,
                        p.timestamp,
                        p.latitude,
                        p.longitude,
                        p.confidence,
                        p.detection_count,
                        p.accuracy || 'N/A'
                    ])
                ].map(row => row.join(',')).join('\n');

                downloadFile('potholes.csv', csv, 'text/csv');
            }

            function exportToGeoJSON() {
                const geojson = {
                    type: 'FeatureCollection',
                    features: potholes.map((p, i) => ({
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [p.longitude, p.latitude]
                        },
                        properties: {
                            id: i + 1,
                            timestamp: p.timestamp,
                            confidence: p.confidence,
                            detection_count: p.detection_count,
                            accuracy: p.accuracy
                        }
                    }))
                };

                downloadFile('potholes.geojson', JSON.stringify(geojson, null, 2), 'application/json')
            }

            function downloadFile(filename, content, mimeType) {
                const blob = new Blob ([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            loadPotholes();
            
            setInterval(loadPotholes, 1000);
        </script>
    </body>
</html>